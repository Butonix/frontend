import expressSession from 'express-session';
import connectPg from 'connect-pg-simple';
import { Pool } from 'pg';

const configPool = new Pool({
  user: 'process.env.SESSIONS_DB_ROLE',
  database: 'process.env.SESSIONS_DB_NAME',
  password: 'process.env.SESSIONS_DB_PASSWORD'
});

const sessionStore = connectPg(expressSession);

function createSessionConnection(app) {
  let session = expressSession({
    secret: 'process.env.SESSIONS_SECRET',
    resave: false,
    rolling: true,
    saveUninitialized: true,
    cookie: {
      httpOnly: true,
      sameSite: true,
      maxAge: 31104000000, // 1 year
      secure: false
    },
    store: new sessionStore({
      pool: configPool,
      tableName: 'process.env.SESSIONS_DB_TABLE'
    })
  });

  app.use(session);
}

export { createSessionConnection };
